<!DOCTYPE html>
<html>
  <head>
  <title>MB Video-Base</title>
  <meta charset="utf-8"></meta>
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"></meta>
  <link rel="icon" type="image/x-icon" href="../../images/MB_Icon_01.png"></link>
  <link rel="stylesheet" href="../../assets/css/main.css"></link>
  <noscript><link rel="stylesheet" href="../../assets/css/noscript.css" /></noscript>
  <script src="Scripts/xlsx.full.min.js"></script>
  <style>
    tbody {width: 100%;height: auto;}
    tr {width: 100%;height: auto;}
    thead {display: none;} /* Verstecke den ursprünglichen Sortierungs-Header */
    .header_number_ {width: 16%;height: 4em;}
    .header_name___ {width: 16%;height: 4em;}
    .header_year___ {width: 16%;height: 4em;}
    .header_runtime {width: 16%;height: 4em;}
    .header_fsk____ {width: 16%;height: 4em;}
    .header_cover__ {width: 20%;height: 4em;}

    .table_number_ {width: 16%;height: auto;text-align: center;vertical-align: middle;background-color: #222222;}
    .table_name___ {width: 16%;height: auto;text-align: left;vertical-align: middle;background-color: #222222;padding: 2%;}
    .table_year___ {width: 16%;height: auto;text-align: center;vertical-align: middle;}
    .table_runtime {width: 16%;height: auto;text-align: center;vertical-align: middle;}
    .table_fsk____ {width: 16%;height: auto;text-align: center;vertical-align: middle;}
    .table_fsk____ img {width: 100%;height: auto;}
    .table_content {width: 16%;height: auto;text-align: justify;overflow: hidden;text-overflow: ellipsis;display: none;}
    .table_poster_ {width: 20%;height: auto;}
    .table_poster_ img {width: 100%;height: auto;}

    .eintrags-gruppe {display: none;}
    .eintrags-gruppe.aktiv {display: block;}

    #pagination-nav button {padding: 0.4em 1em;
      margin: 0.2em;
      background-color: #444;
      color: white;
      border: none;
      cursor: pointer;
      border-radius: 4px;
      transition: background-color 0.2s;
    }
    
    #pagination-nav button:hover {
      background-color: #666;
    }
    
    #pagination-nav button.active-group {
      background-color: #00bfff; /* z. B. hellblau für aktive Gruppe */
      color: black;
      font-weight: bold;
    }
</style>
</head>
<body onload="window.location.href = '#mb_video_base';load_base_a_z();" class="is-preload">
  <div id="wrapper">
    
    <nav id="nav">
      <a href="../../index.html"><img class="mb_icon" src="../../images/MB_Icon_02.png"></img><span>Home</span></a>
      <a href="../../Web-Tools/web-tools.html"><img class="mb_icon" src="../../images/Web_Icon_01.png"></img><span>Web-Tools</span></a>
      <a href="../../Local-Tools/local-tools.html"><img class="mb_icon" src="../../images/CMD_Icon_01.png"></img><span>Local-Tools</span></a>
	  <a href="../../Games/games.html"><img class="mb_icon" src="../../images/Games_Icon_01.png"></img><span>Games</span></a>
      <a href="#mb_video_base"><img class="mb_icon" src="icon_01.png"></img><span>MB Video-Base</span></a>
      
    </nav>
    
    <div id="main">
      <article id="mb_video_base" class="panel">
        <header><h2>MB Video-Base</h2></header>
        <div id="output"></div>
      </article>
    </div>

    <div id="footer"><ul class="copyright"><li>&copy; Master B</li></ul></div>

  </div>
</body>

<script src="../../assets/js/jquery.min.js"></script>
<script src="../../assets/js/browser.min.js"></script>
<script src="../../assets/js/breakpoints.min.js"></script>
<script src="../../assets/js/util.js"></script>
<script src="../../assets/js/main.js"></script>
<script>
  let aktuelleDaten = [];
  let aktuelleSortierung = {};
  let aktuelleGruppe = 'Name';

  async function load_base_a_z() {
    try {
      const response = await fetch('MB Video-Base.xlsx');
      if (!response.ok) throw new Error('Datei konnte nicht geladen werden');
      const arrayBuffer = await response.arrayBuffer();
      const data = new Uint8Array(arrayBuffer);
      const workbook = XLSX.read(data, { type: 'array' });
      const sheetName = workbook.SheetNames[0];
      const worksheet = workbook.Sheets[sheetName];
      const json = XLSX.utils.sheet_to_json(worksheet);
      aktuelleDaten = json;
      renderNavigation();
      renderTabelleGruppiert(json);
    } catch (err) {
      document.getElementById('output').textContent = 'Fehler beim Laden: ' + err.message;
    }
  }

  function renderNavigation() {
    const navContainer = document.createElement('nav');
    navContainer.id = 'pagination-nav';
    
    const zeichen = ['Nummer', 'Name', '0-9', ...'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split(''), 'Zufall'];
    
    zeichen.forEach(z => {
      const btn = document.createElement('button');
      btn.textContent = z;
      btn.onclick = () => {
        if (z === 'Zufall') {
          const gemischt = shuffleArray([...aktuelleDaten]);
          renderTabelleGruppiert(gemischt, 'Zufall');
          zeigeGruppe('Zufall');
        } else if (z === 'Nummer') {
          const sortiert = [...aktuelleDaten].sort((a, b) => {
            const numA = parseInt(a[Object.keys(a)[0]]) || 0;
            const numB = parseInt(b[Object.keys(b)[0]]) || 0;
            return numA - numB;
          });
          renderTabelleGruppiert(sortiert, 'Nummer');
          zeigeGruppe('Nummer');
        } else if (z === 'Name') {
          const sortiert = [...aktuelleDaten].sort((a, b) => {
            const nameA = String(a[Object.keys(a)[1]] ?? '');
            const nameB = String(b[Object.keys(b)[1]] ?? '');
            return nameA.localeCompare(nameB, 'de');
          });
          renderTabelleGruppiert(sortiert, 'Name');
          zeigeGruppe('Name');
        } else {
          zeigeGruppe(z);
        }
      };
      navContainer.appendChild(btn);
    });

    const article = document.querySelector('article#mb_video_base');
    article.insertBefore(navContainer, document.getElementById('output'));

    setTimeout(() => {
      const buttons = document.querySelectorAll('#pagination-nav button');
      let maxWidth = 0;
      
      buttons.forEach(btn => {
        const width = btn.offsetWidth;
        if (width > maxWidth) maxWidth = width;
      });
      
      buttons.forEach(btn => {
        btn.style.width = maxWidth + 'px';
      });
    }, 0);
  }

  function renderTabelleGruppiert(daten, extraGruppe = null) {
    const container = document.getElementById('output');
    container.innerHTML = '';

    const gruppen = {
      'Nummer': [],
      'Name': [],
      'Zufall': [],
      '0-9': [],
      'A': [], 'B': [], 'C': [], 'D': [], 'E': [], 'F': [], 'G': [], 'H': [],
      'I': [], 'J': [], 'K': [], 'L': [], 'M': [], 'N': [], 'O': [], 'P': [],
      'Q': [], 'R': [], 'S': [], 'T': [], 'U': [], 'V': [], 'W': [], 'X': [],
      'Y': [], 'Z': []
    };

    for (const eintrag of daten) {
      const name = eintrag[Object.keys(eintrag)[1]] ?? '';
      const ersterBuchstabe = name.charAt(0).toUpperCase();

      gruppen['Name'].push(eintrag);
      gruppen['Zufall'].push(eintrag);
      gruppen['Nummer'].push(eintrag); // Wichtig!

      if (/[0-9]/.test(ersterBuchstabe)) {
        gruppen['0-9'].push(eintrag);
      } else if (gruppen[ersterBuchstabe]) {
        gruppen[ersterBuchstabe].push(eintrag);
      }
    }

    for (const gruppe in gruppen) {
      const groupDiv = document.createElement('div');
      groupDiv.id = 'gruppe_' + gruppe;
      groupDiv.className = 'eintrags-gruppe';
      if (gruppe === (extraGruppe || 'Name')) groupDiv.classList.add('aktiv');

      let daten = gruppen[gruppe];

      if (gruppe === 'Nummer') {
        daten.sort((a, b) => {
          const numA = parseInt(a[Object.keys(a)[0]]) || 0;
          const numB = parseInt(b[Object.keys(b)[0]]) || 0;
          return numA - numB;
        });
      } else if (gruppe !== 'Zufall') {
        daten.sort((a, b) => {
          const nameA = String(a[Object.keys(a)[1]] ?? '');
          const nameB = String(b[Object.keys(b)[1]] ?? '');
          return nameA.localeCompare(nameB, 'de');
        });
      }

      if (daten.length > 0) {
        const table = generiereTabelle(daten);
        groupDiv.appendChild(table);
      } else {
        groupDiv.innerHTML = '<p>Keine Einträge in dieser Gruppe.</p>';
      }

      container.appendChild(groupDiv);
    }
  }

  function zeigeGruppe(gruppe) {
    aktuelleGruppe = gruppe;

    document.querySelectorAll('.eintrags-gruppe').forEach(div => {
      div.classList.remove('aktiv');
    });
    const aktiv = document.getElementById('gruppe_' + gruppe);
    if (aktiv) aktiv.classList.add('aktiv');

    document.querySelectorAll('#pagination-nav button').forEach(btn => {
      btn.classList.remove('active-group');
      if (btn.textContent === gruppe) {
        btn.classList.add('active-group');
      }
    });
  }

  function shuffleArray(array) {
    for (let i = array.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [array[i], array[j]] = [array[j], array[i]];
    }
    return array;
  }

  function generiereTabelle(daten) {
    const table = document.createElement('table');
    const tbody = document.createElement('tbody');
    const thead = document.createElement('thead');
    const headerRow = document.createElement('tr');

    const keys = Object.keys(daten[0]);
    for (let i = 0; i < keys.length; i++) {
      const key = keys[i];
      const th = document.createElement('th');
      th.innerHTML = key;
      if (i == 0) { th.className = 'header_number_'; }
      else if (i == 1) { th.className = 'header_name___'; }
      else if (i == 2) { th.className = 'header_year___'; }
      else if (i == 3) { th.className = 'header_runtime'; }
      else if (i == 4) { th.className = 'header_fsk____'; }
      else if (i == 5) { th.className = 'header_cover__'; th.innerHTML = ''; }
      // th.addEventListener('click', () => sortiereNachSpalte(key));
      headerRow.appendChild(th);
    }

    thead.appendChild(headerRow);
    table.appendChild(thead);

    for (let i = 0; i < daten.length; i++) {
      const row = daten[i];
      const tr1 = document.createElement('tr');
      const tr2 = document.createElement('tr');
      let movie_id = '';

      for (let j = 0; j < keys.length; j++) {
        const key = keys[j];
        const td = document.createElement('td');
        td.innerHTML = row[key] ?? '';

        if (j == 0) {
          movie_id = td.innerHTML;
          td.className = 'table_number_';
          td.id = movie_id + '_number_';
          td.value = td.innerHTML;
          td.innerHTML = '# ' + td.innerHTML;
          tr1.appendChild(td);
        }
        else if (j == 1) {
          td.className = 'table_name___';
          td.id = movie_id + '_name___';
          td.value = td.innerHTML;
          td.colSpan = 5;
          tr1.appendChild(td);
        }
        else if (j == 2) {
          td.className = 'table_year___';
          td.id = movie_id + '_year___';
          td.value = td.innerHTML;
          td.colSpan = 2;
          td.innerHTML = 'Jahr:<br>' + td.innerHTML;
          tr2.appendChild(td);
        }
        else if (j == 3) {
          td.className = 'table_runtime';
          td.id = movie_id + '_runtime';
          td.value = td.innerHTML;
          td.colSpan = 2;
          td.innerHTML = td.innerHTML + '<br>Minuten';
          tr2.appendChild(td);
        }
        else if (j == 4) {
          td.className = 'table_fsk____';
          td.id = movie_id + '_fsk____';
          td.value = td.innerHTML;

          const erlaubteFSK = ['0', '6', '12', '16', '18'];
          if (erlaubteFSK.includes(td.value)) {
            td.innerHTML = '<img src="Scripts/' + td.value + '.png">';
          } else {
            td.innerHTML = td.value;
          }

          tr2.appendChild(td);
        }
        else if (j == 5) {
          td.className = 'table_poster_';
          td.id = movie_id;
          td.value = td.innerHTML;
          td.innerHTML = '<img src="Cover/' + movie_id + '.jpg">';
          td.addEventListener('click', function () { download_nfo(this); });
          tr2.appendChild(td);
        }
      }
      tbody.appendChild(tr1);
      tbody.appendChild(tr2);
    }

    table.appendChild(tbody);
    return table;
  }

  function sortiereNachSpalte(spalte) {
    const richtung = aktuelleSortierung[spalte] === 'asc' ? 'desc' : 'asc';
    aktuelleDaten.sort((a, b) => {
      const valA = a[spalte] ?? '';
      const valB = b[spalte] ?? '';
      return richtung === 'asc'
        ? valA.toString().localeCompare(valB.toString(), 'de', { numeric: true })
        : valB.toString().localeCompare(valA.toString(), 'de', { numeric: true });
    });

    aktuelleSortierung = { [spalte]: richtung };
    renderTabelleGruppiert(aktuelleDaten);
    zeigeGruppe(aktuelleGruppe); // ← Zeige wieder die richtige Gruppe an
  }

  function download_nfo(obj) {
    var parsing_id = obj.id;
    var title_movie__ = document.getElementById(parsing_id + '_name___').value;
    var number_movie_ = document.getElementById(parsing_id + '_number_').value;
    var runtime_movie = document.getElementById(parsing_id + '_runtime').value;
    var year_movie___ = document.getElementById(parsing_id + '_year___').value;
    var age_movie____ = document.getElementById(parsing_id + '_fsk____').value;
    var content_movie = document.getElementById(parsing_id).value;

    var link = document.createElement("A");
    var filename = title_movie__ + '.nfo';

    var save_content =
      '<?xml version="1.0" encoding="UTF-8" standalone="yes" ?>\n' +
      '<movie>\n' +
      '   <title>' + title_movie__ + '</title>\n' +
      '   <originaltitle>' + title_movie__ + '</originaltitle>\n' +
      '   <plot>' + content_movie + '</plot>\n' +
      '   <runtime>' + runtime_movie + '</runtime>\n' +
      '   <mpaa>' + age_movie____ + '</mpaa>\n' +
      '   <id>' + number_movie_ + '</id>\n' +
      '   <uniqueid type="mbdb">' + number_movie_ + '</uniqueid>\n' +
      '   <year>' + year_movie___ + '</year>\n' +
      '</movie>\n';

    link.setAttribute("href", "data:text/xml," + save_content);
    link.setAttribute("style", "display:none");
    link.setAttribute("download", filename);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  }
</script>