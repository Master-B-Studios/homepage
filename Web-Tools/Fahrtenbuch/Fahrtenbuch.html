<!DOCTYPE html>
<html>
  <head>
  <title>Fahrtenbuch</title>
  <meta charset="utf-8"></meta>
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"></meta>
  <link rel="icon" type="image/x-icon" href="../../images/MB_Icon_01.png"></link>
  <link rel="stylesheet" href="../../assets/css/main.css"></link>
  <noscript><link rel="stylesheet" href="../../assets/css/noscript.css" /></noscript>
  <style>
    .button_row {width: 100%;height: auto;display: flex;align-items: center;justify-content: space-evenly;}
    input[accept=".csv"] {display: none;z-index: 100;cursor: pointer;width: 100%;}
    .icon_button {width: 4em;height: 4em;display: flex;align-items: center;justify-content: center;border-radius: 1em;}
    .icon_button:hover {background-color: #222222;}
    .icon {width: auto;height: 100%;}
    .icon:hover {filter: hue-rotate(80);}

    .car_selection {width: 100%;height: auto;display: flex;}
    #car_text {width: 50%;height: auto;padding: 0.4em;}
    #car_name {width: 50%;height: auto;padding: 0.4em;background-color: #111111;border: 1px solid #000000;border-radius: 0.4em;text-align: center;cursor: pointer;}
    #car_name:hover {outline: none;border: 1px solid #00ff00;color: #00ff00;transition: all 2s;}
    #car_name:focus {outline: none;border: 1px solid #00ff00;color: #00ff00;}

    .div_entry {margin-bottom: 1em;}
    .table_entry {border-radius: 1em;border: 1px solid #dbdbdb;border-collapse: separate;border-spacing: 0.4em;margin: 0 0 1em 0;}
    .table_entry td {padding: 0.4em;}
    .td_info {width: 50%;height: auto;margin: 10px;}
    .td_spec {width: 50%;height: auto;margin: 10px;}
    .td_delete {width: auto;height: auto;color: #ff4400;border: 1px solid #ff4400;border-radius: 0.4em;text-align: center;cursor: pointer;}
    .td_delete:hover {background-color: #ff4400;color: #000000;transition: all 2s;}
    .td_data {width: 50%;height: auto;background-color: #111111;border: 1px solid #000000;border-radius: 0.4em;text-align: center;cursor: pointer;}
    .td_data:hover {outline: none;border: 1px solid #00ff00;color: #00ff00;transition: all 2s;}
    .td_data:focus {outline: none;border: 1px solid #00ff00;color: #00ff00;}
    .td_spec_input {width: 100%;min-height: 2.6em;height: 2.6em;background-color: #111111;border: 1px solid #000000;border-radius: 0.4em;cursor: pointer;}
    .td_spec_input:hover {outline: none;border: 1px solid #00ff00;color: #00ff00;transition: all 2s;}
    .td_spec_input:focus {outline: none;border: 1px solid #00ff00;color: #00ff00;}
    .td_date {width: auto;height: 100%;outline: none;border: none;filter: invert(100%);background-color: rgba(0, 0, 0, 0);opacity: 1;color: #111111;cursor: pointer;}

    .day_container {width: 100%;height: auto;display: flex;}
    .day_text {width: auto;height: auto;padding: 0 0.4em;}
    .day_input {width: 100%;height: auto;padding: 0 0.4em;background-color: #111111;border-radius: 0.4em;outline: none;border: none;text-align: center;color: #dbdbdb;}
    .time_container {width: 100%;height: auto;display: flex;}
  </style>
</head>
<body onload="window.location.href='#fahrtenbuch';" class="is-preload">
  <div id="wrapper">
    
    <nav id="nav">
      <a href="../../index.html"><img class="mb_icon" src="../../images/MB_Icon_02.png"></img><span>Home</span></a>
      <a href="../../Web-Tools/web-tools.html"><img class="mb_icon" src="../../images/Web_Icon_01.png"></img><span>Web-Tools</span></a>
      <a href="../../Local-Tools/local-tools.html"><img class="mb_icon" src="../../images/CMD_Icon_01.png"></img><span>Local-Tools</span></a>
      <a href="../../Games/games.html"><img class="mb_icon" src="../../images/Games_Icon_01.png"></img><span>Games</span></a>
      <a href="#fahrtenbuch"><img class="mb_icon" src="icon_01.png"></img><span>Fahrtenbuch</span></a>
    </nav>
    
    <div id="main">
      <article id="fahrtenbuch" class="panel">
        <header><h2>Fahrtenbuch</h2></header>
        <section>
          <div class="button_row">
            <button class="icon_button" onclick="document.getElementById('load').click()"><img class="icon" src="load_document.png"><input id="load" type="file" accept=".csv" onchange="load_document(this);"></input></button>
            <button class="icon_button" onclick="download_document();"><img class="icon" src="save_document.png"></button>
            <button class="icon_button" onclick="add_entry();"><img class="icon" src="add_entry.png"></button>
          </div>
        </section>
        <section id="car_selection" style="display: none;border: 1px solid #dbdbdb;border-radius: 1em;padding: 0.4em;">
          <div id="car_text">Fahrzeug:</div><div id="car_name" contenteditable="true"></div>
        </section>
        <section><div id="content"></div></section>
      </article>
    </div>
    
    <div id="footer"><ul class="copyright"><li>&copy; Master B</li></ul></div>

  </div>
</body>

<script src="../../assets/js/jquery.min.js"></script>
<script src="../../assets/js/browser.min.js"></script>
<script src="../../assets/js/breakpoints.min.js"></script>
<script src="../../assets/js/util.js"></script>
<script src="../../assets/js/main.js"></script>

<script>
  function load_document(obj) {file = obj.files[0];if (file && file.type == 'text/csv') {import_csv(file);}}
  
  function import_csv(file) {
    const reader = new FileReader();
    reader.onload = function(e) {
      const text = e.target.result;
      const entries = parseKeyValueCSV(text);
      const fahrzeug = getFahrzeugName(entries);
      if (fahrzeug) {document.getElementById('car_name').textContent = fahrzeug;document.getElementById('car_selection').style.display = "flex";}
      showEntriesInTable(entries);
    };
    reader.readAsText(file, "UTF-8");
  }

  function getFahrzeugName(entries) {for (const entry of entries) {if (entry["Fahrzeug"]) {return entry["Fahrzeug"];}}; return null;}

  function parseKeyValueCSV(text) {
    const lines = text.split(/\r?\n/);
    const entries = [];
    const filtered = entries.filter(e => e["Tag"]);
    let current = {};
    lines.forEach(line => {
      if (line.trim() === "") {if (Object.keys(current).length > 0) {entries.push(current);current = {};}; return;}
      const parts = line.split(";");
      const key = parts[0]?.trim();
      const value = parts[1]?.trim();
      if (key) current[key] = value || "";
    });
    if (Object.keys(current).length > 0) {entries.push(current);}
    return entries;
  }
  
  function showEntriesInTable(entries) {
    const filtered = entries.filter(e => e["Tag"]);
    const sorted = filtered.sort((a, b) => {
        const d1 = parseDateTime(a["Tag"], a["Zeit Start"]);
        const d2 = parseDateTime(b["Tag"], b["Zeit Start"]);
        return d2 - d1;
    });
    sorted.forEach(e => {
      const [format_day, format_month, format_year] = e["Tag"].split(".");
      const div = document.getElementById('content');
      const table = document.createElement("table");table.className = 'table_entry';
      const tbody = document.createElement("tbody");
      const row_1 = document.createElement("tr");
      row_1.innerHTML = `
        <td class="td_info">Tag:</td><td class="td_data"><input class="td_date" type="date" value="${format_year}-${format_month}-${format_day}"></td>
      `;
      const row_2 = document.createElement("tr");
      row_2.innerHTML = `
        <td class="td_info">Zeit Start:</td><td class="td_data time_strt" contenteditable="true">${e["Zeit Start"] || ""}</td>
      `
      const row_3 = document.createElement("tr");
      row_3.innerHTML = `
        <td class="td_info">Zeit Ende:</td><td class="td_data time_stop" contenteditable="true">${e["Zeit Ende"] || ""}</td>
      `
      const row_4 = document.createElement("tr");
      row_4.innerHTML = `
        <td class="td_info">Kilometerstand Start:</td><td class="td_data km_strt" contenteditable="true">${e["Kilometerstand Start"] || ""}</td>
      `
      const row_5 = document.createElement("tr");
      row_5.innerHTML = `
        <td class="td_info">Kilometerstand Ende:</td><td class="td_data km_stop" onblur="get_km_difference();" contenteditable="true">${e["Kilometerstand Ende"] || ""}</td>
      `
      const row_6 = document.createElement("tr");
      row_6.innerHTML = `
        <td class="td_info">Gefahrene Kilometer:</td><td class="td_data km_diff" contenteditable="true">${e["Gefahrene Kilometer"] || ""}</td>
      `
      const row_7 = document.createElement("tr");
      row_7.innerHTML = `
        <td class="td_spec">Besonderheiten:</td><td class="td_delete" onclick="delete_table_entry(this);">Eintrag Löschen</td>
      `
      const row_8 = document.createElement("tr");
      row_8.innerHTML = `
        <td class="td_spec_input special" colspan="2" contenteditable="true">${e["Besonderheiten"] || ""}</td>
      `
      div.appendChild(table);table.appendChild(tbody)
      tbody.appendChild(row_1);tbody.appendChild(row_2);tbody.appendChild(row_3);tbody.appendChild(row_4);
      tbody.appendChild(row_5);tbody.appendChild(row_6);tbody.appendChild(row_7);tbody.appendChild(row_8);
    });
    get_km_difference();
  }
  
  function parseDateTime(tag, zeit) {
    if (!tag || !zeit) return new Date(0);
    const [day, month, year] = tag.split(".");
    const [hour, minute] = zeit.split(":");
    return new Date(year, month - 1, day, hour, minute);
  }

  function get_km_difference() {
    const km_diff_input = document.getElementsByClassName('km_diff');
    const km_strt_input = document.getElementsByClassName('km_strt');
    const km_stop_input = document.getElementsByClassName('km_stop');
    for (var i = 0; i < km_diff_input.length; i++) {km_diff_input[i].innerHTML = km_stop_input[i].innerHTML-km_strt_input[i].innerHTML;}
  }

  function add_entry() {
    document.getElementById('car_selection').style.display = "flex";
    const div = document.getElementById('content');
    const table = document.createElement("table");table.className = 'table_entry';
    const tbody = document.createElement("tbody");
    const row_1 = document.createElement("tr");
    row_1.innerHTML = `
      <td class="td_info">Tag:</td><td class="td_data"><input class="td_date" type="date"></td>
    `;
    const row_2 = document.createElement("tr");
    row_2.innerHTML = `
      <td class="td_info">Zeit Start:</td><td class="td_data time_strt" onclick="get_time(this);" contenteditable="true"></td>
    `
    const row_3 = document.createElement("tr");
    row_3.innerHTML = `
      <td class="td_info">Zeit Ende:</td><td class="td_data time_stop" onclick="get_time(this);" contenteditable="true"></td>
    `
    const row_4 = document.createElement("tr");
    row_4.innerHTML = `
      <td class="td_info">Kilometerstand Start:</td><td class="td_data km_strt" onblur="get_km_difference();" contenteditable="true"></td>
    `
    const row_5 = document.createElement("tr");
    row_5.innerHTML = `
      <td class="td_info">Kilometerstand Ende:</td><td class="td_data km_stop" onblur="get_km_difference();" contenteditable="true"></td>
    `
    const row_6 = document.createElement("tr");
    row_6.innerHTML = `
      <td class="td_info">Gefahrene Kilometer:</td><td class="td_data km_diff"></td>
    `
    const row_7 = document.createElement("tr");
    row_7.innerHTML = `
      <td class="td_spec">Besonderheiten:</td><td class="td_delete" onclick="delete_table_entry(this);">Eintrag Löschen</td>
    `
    const row_8 = document.createElement("tr");
    row_8.innerHTML = `
      <td class="td_spec_input special" colspan="2" contenteditable="true"></td>
    `
    div.insertBefore(table, document.getElementsByClassName('table_entry')[0]);table.appendChild(tbody)
    tbody.appendChild(row_1);tbody.appendChild(row_2);tbody.appendChild(row_3);tbody.appendChild(row_4);
    tbody.appendChild(row_5);tbody.appendChild(row_6);tbody.appendChild(row_7);tbody.appendChild(row_8);
    check_day();
  }

  function delete_table_entry(obj) {
    if (confirm('Diesen Eintrag wirklich löschen?') == true) {obj.parentNode.parentNode.parentNode.remove();}
    else {return;}
  }

  function check_day() {
		var date = new Date().toISOString().substring(0, 10);var day = date.substring(8);var month = date.substring(5, 7);var year = date.substring(0, 4);
		const date_field = document.getElementsByClassName('td_date');
    for (var i = 0; i < date_field.length; i++) {if (date_field[i].value == '') {date_field[i].value = year+'-'+month+'-'+day;}}
	}

  function get_time(obj) {
    var time = new Date();
    var minutes = time.getMinutes().toString().length == 1 ? '0' + time.getMinutes() : time.getMinutes();
    var hours = time.getHours().toString().length == 1 ? '0' + time.getHours() : time.getHours();
    obj.innerHTML = hours + ':' + minutes;
  }

  function download_document() {
    const download_car_name = document.getElementById('car_name').innerHTML;
    const time = new Date();
    const seconds = time.getSeconds().toString().length == 1 ? '0' + time.getSeconds() : time.getSeconds();
    const minutes = time.getMinutes().toString().length == 1 ? '0' + time.getMinutes() : time.getMinutes();
    const hours = time.getHours().toString().length == 1 ? '0' + time.getHours() : time.getHours();
    const day = time.getDay().toString().length == 1 ? '0' + time.getDay() : time.getDay();
    const month = time.getMonth().toString().length == 1 ? '0' + time.getMonth() : time.getMonth();
    const year = time.getFullYear().toString().length == 1 ? '0' + time.getFullYear() : time.getFullYear();
    const title_document = download_car_name+' '+year+'-'+month+'-'+day+' '+hours+'-'+minutes+'-'+seconds;

    const table = document.getElementsByClassName('table_entry');
    const day_strt = document.getElementsByClassName('td_date');
    const time_strt = document.getElementsByClassName('time_strt');
    const time_stop = document.getElementsByClassName('time_stop');
    const km_strt = document.getElementsByClassName('km_strt');
    const km_stop = document.getElementsByClassName('km_stop');
    const km_diff = document.getElementsByClassName('km_diff');
    const special = document.getElementsByClassName('special');

    let save_content = 'Fahrzeug;'+download_car_name+';\n\n';
    for (var i = 0; i < table.length; i++) {
      const [start_day_year, start_day_month, start_day_day] = day_strt[i].value.split("-");
      save_content += 'Tag;'+start_day_day+'.'+start_day_month+'.'+start_day_year+';\n';
      save_content += 'Zeit Start;'+time_strt[i].innerHTML+';\n';
      save_content += 'Zeit Ende;'+time_stop[i].innerHTML+';\n';
      save_content += 'Kilometerstand Start;'+km_strt[i].innerHTML+';\n';
      save_content += 'Kilometerstand Ende;'+km_stop[i].innerHTML+';\n';
      save_content += 'Gefahrene Kilometer;'+km_diff[i].innerHTML+';\n';
      save_content += 'Besonderheiten;'+special[i].innerHTML+';\n\n';
    }
    
    const link = document.createElement("A");
    const filename = title_document+'.csv';
    link.setAttribute("href","data:text/xml,"+save_content);link.setAttribute("style","display:none");link.setAttribute("download",filename);document.body.appendChild(link);console.log(link.outerHTML);link.click();document.body.removeChild(link);
  }
</script>